# Soccer Video Organizer

A web application that helps coaches create and review video clips with their team, allowing comments to be shared with players, parents, and other coaches.

## Overview

Soccer Video Organizer is a Next.js application designed to streamline the video analysis process for soccer teams. The platform enables coaches to:

- Create clips from YouTube videos with specific start and end times
- Add coaching points and comments to clips
- Share clips and comments with players and parents
- Control visibility of comments based on user roles

## Features

- **Clip Management**: Create, edit, and organize video clips from YouTube sources
- **Role-Based Access**: Different views and permissions for coaches, players, parents, and administrators
- **Comment System**: Share feedback with targeted visibility (coach-only, player-only, or both)
- **User Management**: Admin panel for managing user roles and permissions
- **Role Request System**: Users can request roles which require admin approval

## Technology Stack

- **Frontend**: Next.js, React, Tailwind CSS
- **Backend**: Supabase (PostgreSQL database with authentication)
- **Authentication**: JWT-based authentication with custom role claims
- **Video Integration**: YouTube embed API

## Getting Started

First, run the development server:

```bash
npm run dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

## Database Setup

### Prerequisites
- [Supabase CLI](https://supabase.com/docs/guides/cli) installed
- [Docker](https://www.docker.com/get-started/) installed and running

### Setup Steps

1. **Configure Environment Variables**

   Create a `.env.local` file in the root directory with the following variables:
   ```
   NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
   NEXT_PUBLIC_SUPABASE_ANON_KEY=<your-anon-key>
   SUPABASE_SERVICE_ROLE_KEY=<your-service-role-key>
   ```

   For production, create a `.env.push` file to use when pushing schema changes:
   ```
   SUPABASE_ACCESS_TOKEN=<your-access-token>
   SUPABASE_DB_PASSWORD=<your-db-password>
   SUPABASE_PROJECT_ID=<your-project-id>
   ```

2. **Initialize Local Supabase Instance**

   ```bash
   supabase start
   ```

3. **Apply Migrations**

   The project includes migration files in ./supabase/migrations

   Run migrations with:
   ```bash
   npm run push-db
   ```

   This command uses the environment variables that are set in .env.push

### Custom Authentication Setup

The application uses a custom JWT claims function to include user roles in authentication tokens:

1. **Role Types**

   The system defines roles as an enum:
   ```sql
   create type public.app_role as enum ('admin', 'coach', 'player', 'parent');
   ```

2. **User Roles Table**

   ```sql
   create table public.user_roles (
     id        bigint generated by default as identity primary key,
     user_id   uuid references auth.users on delete cascade not null,
     role      app_role not null,
     pending_review boolean not null default true,
     unique (user_id, role)
   );
   ```

   The `pending_review` field controls whether a role is actively assigned to a user or pending approval:
   - When `pending_review = true`, the role is requested but not yet active
   - When `pending_review = false`, the role is approved and active
   - The unique constraint on `user_id` and `role` prevents duplicate role requests

3. **JWT Custom Claims Function**

   This function adds user roles to the JWT token when users log in.  It pulls roles from the user_roles table for the user id that is logging in


4. **Enable the Function in Supabase Dashboard**

   In the Supabase Dashboard, go to:
   - Authentication → Configuration → Auth Hooks
   - Enable the "jwt_custom_claims" function for the "Customize Access Token (JWT) Claims" hook

## Database Schema

The application uses two main tables:
- **clips**: Stores video clip information including title, video ID, start/end times
- **comments**: Stores feedback on clips with role-based visibility settings

## User Roles

The application supports multiple user roles:
- **Admin**: Full system access and user management
- **Coach**: Can create clips, add comments, and see all feedback
- **Player**: Can view clips and comments shared with them
- **Parent**: Can view clips and appropriate comments

## Deployment

The application can be deployed on Vercel, the platform from the creators of Next.js.

## License

This project is [GPLv3 licensed](LICENSE).
